;;; package --- dired-custom-extension.el -*- lexical-binding:t -*-
;; Time-stamp: <2022-03-17 11:13:40 Thursday by zhengyuli>

;; Copyright (C) 2021, 2022 zhengyu li
;;
;; Author: zhengyu li <lizhengyu419@outlook.com>
;; Version: 0.0.1
;; Keywords: none

;; This file is not part of GNU Emacs.

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with this program.  If not, see <http://www.gnu.org/licenses/>.

;;; Commentary:

;;

;; Put this file into your load-path and the following into your ~/.emacs:
;;   (require 'dired-custom-extension)

;;; Require:
(require 'files)
(require 'simple)
(require 'dired)
(require 'dired-single)
(require 'dired-hacks-utils)

;;; Code:
;; ==================================================================================
(defun dired-goto-first-line ()
  "Dired go to the first line."
  (interactive)
  (dired-revert)
  (beginning-of-buffer)
  (dired-hacks-next-file))

(defun dired-goto-last-line ()
  "Dired go to the last line."
  (interactive)
  (dired-revert)
  (end-of-buffer)
  (dired-hacks-previous-file))

(defun dired-up-directory-single ()
  "Return up directory in single window."
  (interactive)
  (let ((dir (dired-current-directory)))
    (dired-single-buffer "..")
    (dired-goto-file dir)))

(defun dired-backup-file ()
  "Backup file in current directory."
  (interactive)
  (let* ((origin-files (dired-get-marked-files)))
    (dolist (origin-file origin-files)
      (condition-case nil
          (if (file-directory-p origin-file)
              (copy-directory origin-file (concat origin-file ".back") 1)
            (copy-file origin-file (concat origin-file ".back") 1))
        (error nil)))
    (dired-revert)))

(defun dired-get-size ()
  "Get total size of marked files."
  (interactive)
  (let ((files (dired-get-marked-files)))
    (with-temp-buffer
      (apply 'call-process "du" nil t nil "-sch" files)
      (message "Size of all marked files: %s"
               (progn
                 (re-search-backward "^\\s-*\\([0-9.,]+[A-Za-z]+\\).*\\(total\\|总用量\\)$")
                 (match-string 1))))))

(defun dired-get-file-name (with-full-path only-path)
  "Dired get file name.
If `WITH-FULL-PATH' is nil and `ONLY-PATH' is nil, return only file name,
If `WITH-FULL-PATH' is t and `ONLY-PATH' is nil, return full file path,
If `WITH-FULL-PATH' is nil and `ONLY-PATH' is t, return only file path,
If `WITH-FULL-PATH' is t and `ONLY-PATH' is t, return only file path."
  (let ((clipboard))
    (if only-path
        (if (equal 'windows-nt system-type)
            (setq clipboard (replace-regexp-in-string "/" "\\\\" (dired-current-directory)))
          (setq clipboard (dired-current-directory)))
      (let ((file (dired-get-file-for-visit)))
        (if with-full-path
            (progn
              (if (file-directory-p file)
                  (setq file (concat file "/")))
              (if(equal 'windows-nt system-type)
                  (setq clipboard (replace-regexp-in-string "/" "\\\\" file))
                (setq clipboard file)))
          (if (file-directory-p file)
              (setq clipboard (file-name-nondirectory file))
            (setq clipboard (file-name-nondirectory file))))))

    (kill-new clipboard)
    (message "copy string \"%s\" to clipboard" clipboard)))

(defun dired-get-file-name-with-path ()
  "Dired get file name with path."
  (interactive)
  (dired-get-file-name t nil))

(defun dired-get-file-name-without-path ()
  "Dired get file name without path."
  (interactive)
  (dired-get-file-name nil nil))

(defun dired-get-file-name-only-path ()
  "Dired get file name only path."
  (interactive)
  (dired-get-file-name t t))

(defun dired-custom-sort ()
  "Show directories first in dired mode.
This is a fallback for systems without --group-directories-first support.
If dired-listing-switches includes --group-directories-first, this function
is a no-op as the sorting is handled by ls."
  (unless (string-match-p "--group-directories-first" (or dired-listing-switches ""))
    (save-excursion
      (let (buffer-read-only)
        (forward-line 2)
        (sort-regexp-fields t "^.*$" "[ ]*." (point) (point-max))))
    (set-buffer-modified-p nil)))

;; ==================================================================================
;; Copy/Cut/Paste functionality (replaces dired-copy-paste package)
(defvar dired-clipboard-files nil
  "List of files stored in dired clipboard.")

(defvar dired-clipboard-operation nil
  "Operation type: 'copy or 'move.")

(defun dired-copy-files ()
  "Copy marked files (or file at point) to dired clipboard."
  (interactive)
  (setq dired-clipboard-files (dired-get-marked-files)
        dired-clipboard-operation 'copy)
  (message "Copied %d file(s)" (length dired-clipboard-files)))

(defun dired-cut-files ()
  "Cut marked files (or file at point) to dired clipboard."
  (interactive)
  (setq dired-clipboard-files (dired-get-marked-files)
        dired-clipboard-operation 'move)
  (message "Cut %d file(s)" (length dired-clipboard-files)))

(defun dired-paste-files ()
  "Paste files from dired clipboard to current directory."
  (interactive)
  (if (not dired-clipboard-files)
      (message "Clipboard is empty")
    (let ((dest (dired-current-directory))
          (count 0))
      (dolist (file dired-clipboard-files)
        (condition-case err
            (progn
              (if (eq dired-clipboard-operation 'move)
                  (rename-file file dest 1)
                (copy-file file dest 1))
              (setq count (1+ count)))
          (error (message "Error: %s" err))))
      (when (eq dired-clipboard-operation 'move)
        (setq dired-clipboard-files nil
              dired-clipboard-operation nil))
      (revert-buffer)
      (message "Pasted %d file(s) to %s" count dest))))

;; ==================================================================================
;;; Provide features
(provide 'dired-custom-extension)

;;; dired-custom-extension.el ends here
